name: check dependencies vulnerabilities

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  check-server-lib:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Server

    steps:
    - uses: actions/checkout@v3

    - name: Install Node.js 18.15.0
      uses: actions/setup-node@v3
      with:
        node-version: 18.15.0
      
    - name: Install dependencies
      run: npm ci

    - name: Audit dependencies
      run: npm audit --audit-level=low
      run: npm audit --audit-level=moderate
      run: npm audit --audit-level=high
      run: npm audit --audit-level=critical
      

    # if no vulnerabilities found, write no vulnerabilities found in the pull request
    # else write the vulnerabilities found in the pull request and unpermitted to merge
    - name: Check vulnerabilities
      if: ${{ always() }}
      run: |
        if [ -s "audit.json" ]; then
          echo "Vulnerabilities found"
          echo "Unpermitted to merge"
          exit 1
        else
          echo "No vulnerabilities found"
          exit 0
        fi

      

  # check-client-lib:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: Client

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Install Node.js 18.15.0
  #     uses: actions/setup-node@v3
  #     with:
  #       node-version: 18.15.0
      
  #   - name: Install dependencies
  #     run: npm ci

  #   - name: Audit dependencies
  #     run: npm audit --audit-level=low
  #     run: npm audit --audit-level=moderate
  #     run: npm audit --audit-level=high
  #     run: npm audit --audit-level=critical

      